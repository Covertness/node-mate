# MATE协议

------

P2P网络中经常需要快速准确地发现目标节点，由于如今网络的复杂化使得这一目标并不容易达成，尤其是存在大量通过NAT实现的专有网络的情况下。此协议旨在解决现有网络条件下发现P2P节点并保证其可用性的问题，它借鉴了部分[DHT协议](http://www.bittorrent.org/beps/bep_0005.html)的实现原理，但它并不同于DHT协议。

## 概述
网络中每个节点都使用一串[UUID](http://zh.wikipedia.org/wiki/通用唯一识别码)作为ID，此ID作为节点在整个网络中的唯一标识符，用于后续节点的发现与连接。任一节点已知的所有节点（包括自身）信息都存放于由[Kademlia](http://zh.wikipedia.org/wiki/Kademlia)算法实现的路由表中,它使用节点ID作为索引，ID异或结果作为节点间距离，因而可在路由表中找出距离某一节点最近的一些节点（非地理位置距离）。
协议基于UDP实现，主要包括节点发现与节点连接两部分，其总体流程如下图所示。

![](findNode.png)

### 节点发现
假设自身节点为M，需要寻找的节点ID为N。首先在M的路由表中查询N，获得异或距离最近的一些节点信息列表。如果列表中包含N则表明已经找到所需节点，发现流程结束；否则继续对列表中每个节点的路由表都发起查询请求，依此递归操作，直到超时。时序图如下。

![](lookup.png)

### 节点连接
假设自身节点为M，需要寻找的节点为N，包含N的路由表所在节点为S，起始连接状态为connecting（连接中）。M首先使用S做代理连接N，如果连接成功则将连接状态改为tranship（转发），否则连接失败。时序图如下。

![](indirect.png)

然后M尝试直接连接N，如果连接成功则将连接状态置为connected（已连接）。时序图如下。

![](direct.png)

具体连接过程与TCP连接类似，包括以下几个步骤：
> 1. 连接发起端向被连接端发送connect；
> 2. 被连接端回应conack；
> 3. 连接发起端向被连接端发送concomp；
> 4. 连接两端周期性向对方发送ping；
> 5. 连接两端在一定时间内（大于ping周期）未收到回应则连接失败。
